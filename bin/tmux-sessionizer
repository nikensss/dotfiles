#!/usr/bin/env bash

function option_basename() {
  basename $(echo $1 | perl -pe 's/^\((repo|session)\) (.*)$/\2/')
}

function get_options() {
  session_basenames=$(tmux list-sessions -F '#S' 2> /dev/null | xargs echo)
  tmux list-sessions -F '#S' 2> /dev/null | xargs -I _ echo \(session\) _ | sort | uniq

  repos=$(fd -t d -HI --search-path ~/repos '.git' -E 'node_modules' -x dirname | sort | uniq)

  for repo in ${repos[@]}; do
    repo_basename=$(option_basename "$repo")
    if ! echo "$session_basenames" | grep -q "$repo_basename"; then
      echo "(repo) $repo"
    fi
  done
}

if [[ $# -eq 1 ]]; then
    selected=$1
else
    selected=$(get_options | fzf)
fi

if [[ -z $selected ]]; then
    exit 0
fi

selected=$(echo $selected | perl -pe 's/^\((repo|session)\) (.*)$/\2/')
selected_name=$(basename $selected | tr . _)

tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    tmux new-session -s $selected_name -c $selected
    exit 0
fi

if ! tmux has-session -t=$selected_name 2> /dev/null; then
    tmux new-session -ds $selected_name -c $selected
fi

tmux switch-client -t $selected_name
