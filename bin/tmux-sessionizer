#!/usr/bin/env bash

function tag(){
  session_basenames=$(tmux list-sessions -F '#S' 2> /dev/null | xargs)
  while read -r line; do
    if ! echo "$session_basenames" | grep -q "$(basename "$line")"; then
      echo "(repo) $line"
    fi
  done
}

function get_options() {
  # List active tmux sessions
  tmux list-sessions -F '(session) #S' 2> /dev/null | sort | uniq

  # Use fdfind on Ubuntu/Debian, fd on macOS
  local fd_cmd="fd"
  if command -v fdfind > /dev/null 2>&1; then
    fd_cmd="fdfind"
  fi

  # Find all git repos at ~/repos/ level only (no nested repos)
  $fd_cmd -t d -HI --max-depth 2 --search-path ~/repos '.git' -E 'node_modules' -x dirname | \
    sort -u | \
    tag
}

if [[ $# -eq 1 ]]; then
    selected=$1
else
    selected=$(get_options | fzf)
fi

if [[ -z $selected ]]; then
    exit 0
fi

selected=$(echo $selected | perl -pe 's/^\((repo|session)\) (.*)$/\2/')
selected_name=$(basename $selected | tr . _)

tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    tmux new-session -s $selected_name -c $selected
    exit 0
fi

if ! tmux has-session -t=$selected_name 2> /dev/null; then
    tmux new-session -ds $selected_name -c $selected
fi

tmux switch-client -t $selected_name
