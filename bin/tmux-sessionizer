#!/usr/bin/env bash

function option_basename() {
  basename $(echo $1 | perl -pe 's/^\((repo|session)\) (.*)$/\2/')
}

if [[ $# -eq 1 ]]; then
    selected=$1
else
    session_basenames=$(tmux list-sessions -F '#S' 2>/dev/null | xargs echo)
    sessions=$(tmux list-sessions -F '#S' 2>/dev/null | xargs -I _ echo \(session\) _ | sort | uniq)
    repos=$(fd -t d -HI --search-path ~/repos '.git' -E 'node_modules' -x dirname | sort | uniq)
    repos_to_show=""

    for repo in ${repos[@]}; do
      repo_basename=$(option_basename "$repo")
      if ! echo "$session_basenames" | grep -q "$repo_basename"; then
        repos_to_show=""$repos_to_show"\n(repo) $repo"
      fi
    done
    repos=("$repos_to_show")

    selected=$(echo -e "$sessions" "$repos" | fzf)
fi

if [[ -z $selected ]]; then
    exit 0
fi

trimmed=$(echo $selected | perl -pe 's/^\((repo|session)\) (.*)$/\2/')
selected_name=$(basename $trimmed | tr . _)
tmux_running=$(pgrep tmux)

if [[ -z $TMUX ]] && [[ -z $tmux_running ]]; then
    tmux new-session -s $selected_name -c $selected
    exit 0
fi

if ! tmux has-session -t=$selected_name 2> /dev/null; then
    tmux new-session -ds $selected_name -c $selected
fi

tmux switch-client -t $selected_name
