#!/usr/bin/env bash

if [[ ! -f ~/bin/.env ]]; then
  echo "Missing '~/bin/.env' file"
  exit 1
fi

source ~/bin/.env

echo "Logging in with: $UNIVERSAL_LOGIN_EMAIL"

case "$1" in
  'prod')
    source ~/bin/.env.ul.prod
    ;;
  'stage')
    source ~/bin/.env.ul.stage
    ;;
  *)
    echo "Unknown env $1, use 'prod' or 'stage'"
    exit 1
    ;;
esac

TOKEN=$(curl -s -X "POST" \
  "$UNIVERSAL_LOGIN_URL" \
  -H 'accept: application/json' \
  -H "client-id: $UNIVERSAL_LOGIN_CLIENT_ID" \
  -H "redirect-uri: $UNIVERSAL_LOGIN_REDIRECT_URI" \
  -H "Content-Type: application/json" \
  -d "{ \"email\": \"$UNIVERSAL_LOGIN_EMAIL\", \"password\": \"$UNIVERSAL_LOGIN_PASSWORD\", \"keepLoggedIn\": true }" \
  | jq '.accessToken' | xargs)

echo $TOKEN | tr -d '\n' | pbcopy

echo "Token: $TOKEN"
echo "Available in the clipboard"
