#!/usr/bin/env bash

up(){
  local AMOUNT=$1
  for i in {1..$AMOUNT}
  do
    cd ..
  done
}

kp() {
  PID=$(echo $(lsof -n -i4TCP:$1) | awk 'NR==1{print $11}')
  kill -9 $PID
}

wu(){
  lsof -i tcp:$1
}

cln(){
  git clone $1
  cd "$(basename "$1" .git)"
  v
}

mcd () {
  mkdir -p $1
  cd $1
}

ctp(){
  if [ -z "$1" ]
    then
      echo "Project name not provided"
      return 1
  fi

  mkdir $1
  cd $1
  git init

  echo "node_modules\n.DS_Store\n.env*\ndist" > .gitignore
  touch .env

  npm init --yes
  echo 'save-exact=true' > .npmrc

  NODE_VERSION=$(node -v | sed 's/^v\([^\.]*\).\([^\.]*\)\..*$/\1.\2/')
  npm i -D rimraf typescript ts-node eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin prettier eslint-config-prettier eslint-plugin-prettier @commitlint/cli @commitlint/config-conventional husky @types/node@$NODE_VERSION @total-typescript/ts-reset cross-os
  npm i dotenv zod

  echo '{ "parser": "@typescript-eslint/parser", "parserOptions": { "project":"./tsconfig.json" }, "extends": [ "plugin:@typescript-eslint/recommended","plugin:prettier/recommended","prettier" ], "rules": { "consistent-return": 1, "eqeqeq": 1, "no-param-reassign": 1, "@typescript-eslint/no-floating-promises": 2, "@typescript-eslint/explicit-function-return-type": 2, "@typescript-eslint/explicit-module-boundary-types": 2} }' > .eslintrc.json
  echo '{ "printWidth": 120, "tabWidth": 2, "useTabs": false, "semi": true, "singleQuote": true, "trailingComma": "none", "arrowParens": "avoid" }' > .prettierrc.json
  echo '{ "extends": ["@commitlint/config-conventional"] }' > .commitlintrc.json

  npx tsc --init --target ES2021 --outDir './dist/'
  mkdir src
  touch src/env.ts
  touch src/index.ts
  cat << _EOF_ >> src/env.ts
import { z } from 'zod';

const envSchema = z.object({
  NODE_ENV: z.enum(['development', 'production', 'test']),
});

export const env = envSchema.parse(process.env);
_EOF_

  cat << _EOF_ >> src/index.ts
import { env } from './env'; 

const main = async (): Promise<void> => {
  console.log('Hello, World!', { env });
};

main()
  .then(() => console.log('Done!'))
  .catch(console.error);
_EOF_

  echo "import '@total-typescript/ts-reset';" > reset.d.ts

  npm pkg set version="0.1.0"
  npm pkg set scripts.build="rimraf ./dist && tsc"
  npm pkg set scripts.start="node -r dotenv/config ./dist/index.js"
  npm pkg set scripts.start:dev="ts-node -r dotenv/config ./src/index.ts"
  npm pkg set scripts.pretty="cross-os pretty"
  npm pkg set scripts.pretty:check="cross-os pretty:check"
  npm pkg set scripts.lint="cross-os lint"
  npm pkg set scripts.prepare="husky install"
  npm pkg set cross-os.lint.darwin="eslint 'src/**/*.ts'"
  npm pkg set cross-os.lint.win32="eslint src/**/*.ts"
  npm pkg set cross-os.pretty:check.darwin="prettier --check 'src/**/*.ts'"
  npm pkg set cross-os.pretty:check.win32="prettier --check src/**/*.ts"
  npm pkg set cross-os.pretty.darwin="prettier --write 'src/**/*.ts'"
  npm pkg set cross-os.pretty.win32="prettier --write src/**/*.ts"

  npm run prepare

  npx --yes husky add .husky/pre-commit "npm run pretty:check && npm run lint"
  npx --yes husky add .husky/commit-msg 'npx --no -- commitlint --edit $1'
  npx --yes husky add .husky/pre-push ""

  cat << _EOF_ >> .husky/pre-push
STATUS=\$(git status --porcelain | wc -l | xargs)
FILES=\$(git status --porcelain | sed -n "s;^.. \(.*\)\$;\\\\\t\\\\\t\1\\\\\n;p")

RED='\033[0;31m'
GREEN='\033[0;32m'
NO_COLOR='\033[0m'

if [ \$STATUS -ne 0 ]; then
  echo \$RED'✖ Make sure all changes are staged and committed before pushing'\$NO_COLOR
  echo \$RED'\tDetected changes in:'\$NO_COLOR
  echo \$RED\$FILES\$NO_COLOR
  exit 1
fi

echo \$GREEN'✓ No changes left to commit'\$NO_COLOR

_EOF_

  npx prettier --write './**/*.{json,ts}'

  git add --all
  git commit -am "chore: initial commit"

  npm run build
  npm run start
}

md2pdf(){
  npx --yes markdown-pdf $1
}

dsf(){
  diff -u $1 $2 | diff-so-fancy
}

fni(){
  NODE_VERSION=$1
  echo "Getting global packages"
  GLOBAL_PACKAGES=$(npm ls -g --json | jq '.dependencies | keys | .[]' | xargs)

  fnm install $NODE_VERSION
  fnm use $NODE_VERSION

  echo "Reinstalling global packages"
  echo $GLOBAL_PACKAGES | xargs npm i -g
}

wsql(){
  local TARGET=$1

  if [[ -z "$TARGET" ]]; then
    echo "no target provided"
    exit 1
  fi

  case "$TARGET" in
    "production-body-metrics")
      source ~/bin/.env.bm.prod 
      ;;
    "staging-body-metrics")
      source ~/bin/.env.bm.stage
      ;;
    "identification-service-pro")
      source ~/bin/.env.identification-service.pro
      ;;
    "production-universal-login")
      source ~/bin/.env.ul.prod
      ;;
    "stage-universal-login")
      source ~/bin/.env.ul.stage
      ;;
    "playtomic-bot-api-prod")
      source ~/bin/.env.playtomic-bot-api.prod
      ;;
    "playtomic-bot-api-dev")
      source ~/bin/.env.playtomic-bot-api.dev
      ;;
    "playtomic-bot-api-test")
      source ~/bin/.env.playtomic-bot-api.test
      ;;
    *)
      echo "unknown postgres target '$TARGET'"
      echo "use one of:"
      echo "\tproduction-body-metrics"
      echo "\tstaging-body-metrics"
      echo "\tidentification-service-pro"
      echo "\tproduction-universal-login"
      echo "\tstage-universal-login"
      echo "\tplaytomic-bot-api-prod"
      echo "\tplaytomic-bot-api-dev"
      echo "\tplaytomic-bot-api-test"
      return
      ;;
  esac

  PGPASSWORD="$PGPASSWORD" psql -h $PGHOST -p $PGPORT -U $PGUSER $PGDATABASE
}
