#!/usr/bin/env bash

up(){
  local AMOUNT=$1
  for i in {1..$AMOUNT}
  do
    cd ..
  done
}

kp() {
  PID=$(echo $(lsof -n -i4TCP:$1) | awk 'NR==1{print $11}')
  kill -9 $PID
}

wu(){
  lsof -i tcp:$1
}

cln(){
  git clone $1
  cd "$(basename "$1" .git)"
  v
}

mcd () {
  mkdir -p $1
  cd $1
}

ctp(){
  if [ -z "$1" ]
    then
      echo "Project name not provided"
      return 1
  fi

  mcd $1
  git init

  echo "node_modules\n.DS_Store\n.env\ndist" > .gitignore

  npm init --yes
  echo 'save-exact=true' > .npmrc

  npm i -D typescript ts-node eslint @typescript-eslint/parser @typescript-eslint/eslint-plugin prettier eslint-config-prettier eslint-plugin-prettier @commitlint/cli @commitlint/config-conventional husky
  npm i dotenv

  echo '{ "parser": "@typescript-eslint/parser", "parserOptions": { "project":"./tsconfig.json" }, "extends": [ "plugin:@typescript-eslint/recommended","plugin:prettier/recommended","prettier" ], "rules": { "consistent-return": 1, "eqeqeq": 1, "no-param-reassign": 1, "@typescript-eslint/no-floating-promises": 2, "@typescript-eslint/explicit-function-return-type": 2, "@typescript-eslint/explicit-module-boundary-types": 2} }' > .eslintrc.json
  echo '{ "printWidth": 120, "tabWidth": 2, "useTabs": false, "semi": true, "singleQuote": true, "trailingComma": "none", "arrowParens": "avoid" }' > .prettierrc.json
  echo '{ "extends": ["@commitlint/config-conventional"] }' > .commitlintrc.json

  tsc --init
  mkdir src
  touch src/index.ts
  echo "const main = async (): Promise<void> => {console.log('Hello, World!');}\n\nmain().then( () => console.log('Done!') ).catch(console.error);" > src/index.ts

  npm pkg set version="0.1.0"
  npm pkg set scripts.start="ts-node -r dotenv/config src/index.ts"
  npm pkg set scripts.pretty="prettier --write 'src/**/*.ts'"
  npm pkg set scripts.pretty:check="prettier --check 'src/**/*.ts'"
  npm pkg set scripts.lint="eslint 'src/**/*.ts'"
  npm pkg set scripts.prepare="husky install"

  npm run prepare

  npx --yes husky add .husky/pre-commit "npm run pretty:check && npm run lint"
  npx --yes husky add .husky/commit-msg 'npx --no -- commitlint --edit $1'
  npx --yes husky add .husky/pre-push ""

  cat << _EOF_ >> .husky/pre-push
STATUS=\$(git status --porcelain | wc -l | xargs)
FILES=\$(git status --porcelain | sed -n "s;^.. \(.*\)\$;\\\\\t\\\\\t\1\\\\\n;p")

RED='\033[0;31m'
GREEN='\033[0;32m'
NO_COLOR='\033[0m'

if [ \$STATUS -ne 0 ]; then
  echo \$RED'✖ Make sure all changes are staged and committed before pushing'\$NO_COLOR
  echo \$RED'\tDetected changes in:'\$NO_COLOR
  echo \$RED\$FILES\$NO_COLOR
  exit 1
fi

echo \$GREEN'✓ No changes left to commit'\$NO_COLOR

_EOF_

  prettier --write './**/*{json,ts}'

  git add --all
  git commit -am "chore: initial commit"

  npm run start
}

md2pdf(){
  npx --yes markdown-pdf $1
}

dsf(){
  diff -u $1 $2 | diff-so-fancy
}

fni(){
  NODE_VERSION=$1
  echo "Getting global packages"
  GLOBAL_PACKAGES=$(npm ls -g --json | jq '.dependencies | keys | .[]' | xargs)

  fnm install $NODE_VERSION
  fnm use $NODE_VERSION
  echo "Reinstalling global packages"
  echo $GLOBAL_PACKAGES | xargs npm i -g
}

bmpsql(){
  local ENV=$1

  if [[ -z "$ENV" ]]; then
    echo "no environment provided: use 'stage' or 'prod'"
    exit 1
  fi

  case "$ENV" in
    "prod")
      source ~/bin/.env.bm.prod 
      ;;
    "stage")
      source ~/bin/.env.bm.stage
      ;;
    *)
      echo "unknown environment '$ENV': use 'stage' or 'prod'"
      exit 1
      ;;
  esac

  psql -h $PGHOST -p $PGPORT -U $PGUSER $PGDATABASE
}
